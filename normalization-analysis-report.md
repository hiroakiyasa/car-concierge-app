# 駐車場料金計算アルゴリズム 正規化ルール準拠性分析レポート

## 概要
Supabaseバックエンドの駐車料金計算実装（`parking-fee.service.ts`）と提供された正規化ルールを比較分析した結果、重大な問題1件、中程度の問題1件、軽微な問題2件を発見しました。

## 発見された問題点

### 🔴 重大な問題（要修正）

#### 1. `progressive`タイプの未実装
- **現状**: `type: 'progressive'`が認識されない
- **影響**: 初回無料料金（例: 初回30分無料、その後10分200円）が正しく計算されない
- **該当コード**: 現在は`type === 'base'`と`type === 'max'`のみ対応
- **修正案**:
  ```typescript
  // progressiveタイプの処理を追加
  if (rate.type === 'progressive' && rate.applyAfter) {
    // applyAfter分まで無料、その後は指定料金
  }
  ```

### 🟡 中程度の問題

#### 2. `day_type`の値の不一致
- **現状**: `"平日"`として処理（line 309-316）
- **正規化ルール**: `"月～金"`を期待
- **影響**: データベースに`"月～金"`として保存された料金が適用されない
- **修正案**:
  ```typescript
  // 現在のコード
  if (rate.dayType === '平日' && (isWeekend || isHoliday)) continue;

  // 修正後
  if ((rate.dayType === '平日' || rate.dayType === '月～金') && (isWeekend || isHoliday)) continue;
  ```

### 🔵 軽微な問題

#### 3. `applyAfter`の実装位置
- **現状**: `base`タイプに実装（line 211-226）
- **正規化ルール**: `progressive`タイプ専用
- **影響**: 機能は動作するが、データ構造が正規化ルールと異なる
- **推奨**: progressiveタイプ実装時に移行

#### 4. 特別な最大料金表記への対応
- **現状**: `minutes: 0`の解釈が不明確
- **正規化ルール**: `"当日最大"`、`"入庫後X時間"`の明確な定義必要
- **推奨**: ドキュメント化とテストケース追加

## ✅ 正しく実装されている部分

1. **時間範囲の境界処理** (line 404-443)
   - 半開区間`[開始, 終了)`として正しく実装
   - 日またぎ（22:00～8:00）も正しく処理

2. **conditional_free処理** (line 59-63)
   - 条件付き無料は-1を返す仕様に準拠

3. **最大料金の繰り返し適用** (line 70-93)
   - 24時間を超える場合の処理が正しい

4. **料金優先順位** (line 338-342)
   - より具体的な条件（時間帯指定 > 曜日指定）を優先

## 修正優先度と推奨アクション

### 即座に修正すべき項目
1. **progressiveタイプのサポート追加**
   - 新規タイプとして実装
   - applyAfterをprogressiveタイプ専用に移行
   - テストケースの追加

2. **day_typeの値対応**
   - `"月～金"`を認識するよう条件文を修正
   - 既存の`"平日"`との互換性維持

### 中期的な改善項目
1. **データ正規化の徹底**
   - データベース側で正規化ルールを強制
   - バリデーション機能の追加

2. **テストカバレッジの拡充**
   - 正規化ルール準拠のテストスイート作成
   - エッジケースの網羅

## テスト結果サマリー

全50パターンのテストで100%の成功率を達成していますが、これは現在の実装に合わせたテストデータを使用しているためです。正規化ルールに準拠したデータでは以下の問題が発生する可能性があります：

- `progressive`タイプ: 認識されず計算エラー
- `"月～金"`指定: 料金が適用されない
- `applyAfter`の位置: progressiveタイプで動作しない

## 結論

現在の実装は多くの複雑なケースを正しく処理できていますが、正規化ルールとの完全な互換性のためには、特に`progressive`タイプの実装と`day_type`値の対応が必要です。これらの修正により、データベースに保存された正規化済みデータを正しく処理できるようになります。