# 認証システムテスト手順

## 📱 テスト画面へのアクセス方法

1. アプリを起動
2. MapScreen画面で、以下のいずれかの方法でTestAuth画面へ遷移：
   - デバッグメニューから「TestAuth」を選択
   - または、MapScreen.tsxに一時的にボタンを追加

## 🧪 テスト手順

### 1. 新規登録テスト
```
メール: test@example.com
パスワード: testpass123
名前: Test User
```
- 「📝 新規登録テスト」ボタンをタップ
- 期待結果：
  - ✅ 新規登録成功
  - セッション有効
  - プロフィール作成済み

### 2. ログインテスト
```
メール: test@example.com
パスワード: testpass123
```
- 「🔑 ログインテスト」ボタンをタップ
- 期待結果：
  - ✅ ログイン成功
  - セッション有効
  - ユーザー情報取得

### 3. ログアウトテスト
- 「🚪 ログアウトテスト」ボタンをタップ
- 期待結果：
  - ✅ ログアウト完了
  - セッション無効
  - Store状態クリア

### 4. 認証状態確認
- 「🔍 認証状態確認」ボタンをタップ
- Store状態とSupabaseセッションの同期を確認

## 🔧 修正内容

### 1. データベース修正
- 欠落していたuser_profilesレコードを追加
- auth.usersとuser_profilesの不整合を解消

### 2. AuthService改善
- プロフィール作成を安全なUPSERT処理に変更
- signIn時の不要なセッションクリアを条件付きに変更
- エラーハンドリングを強化

### 3. AuthStore改善
- isInitializedフラグを追加して初期化状態を追跡
- セッション復元ロジックを改善
- エラー時の状態管理を強化

## ✅ 確認ポイント

1. **新規登録フロー**
   - [ ] ユーザーがauth.usersに作成される
   - [ ] user_profilesに対応するプロフィールが作成される
   - [ ] セッションが正常に確立される
   - [ ] AuthStoreの状態が正しく更新される

2. **ログインフロー**
   - [ ] 既存ユーザーでログインできる
   - [ ] セッションが正常に復元される
   - [ ] プロフィール情報が取得できる
   - [ ] 複数回ログインしてもエラーが発生しない

3. **ログアウトフロー**
   - [ ] セッションが正常にクリアされる
   - [ ] ローカルストレージがクリアされる
   - [ ] AuthStoreの状態がリセットされる

4. **セッション永続性**
   - [ ] アプリ再起動後もログイン状態が維持される
   - [ ] セッション期限切れが適切に処理される
   - [ ] 認証状態の変更が適切に検知される

## 🐛 既知の問題と対策

### 問題1: プロフィール作成の重複エラー
- **原因**: 複数の非同期処理が同時にプロフィールを作成しようとする
- **対策**: UPSERTを使用し、既存チェックを実装

### 問題2: セッション不整合
- **原因**: signIn時に既存セッションを無条件にクリア
- **対策**: 異なるユーザーの場合のみクリア

### 問題3: 初期化タイミング
- **原因**: App.tsxでの非同期初期化が完了前に画面遷移
- **対策**: isInitializedフラグで初期化完了を追跡

## 📝 テスト用アカウント

既存のテストアカウント：
- hiroakiyasa@gmail.com (プロフィール修復済み)
- その他3つのアカウント（プロフィール確認済み）

新規テスト用：
- test@example.com / testpass123
- test2@example.com / testpass456